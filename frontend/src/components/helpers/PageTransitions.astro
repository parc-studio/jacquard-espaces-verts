---
/**
 * PageTransitions
 *
 * GSAP-powered page transition animations that work alongside
 * Astro's View Transitions API (ClientRouter).
 *
 * Architecture:
 * - This component (orchestrator) handles Astro lifecycle events
 * - scripts/transitions/index.ts (engine) builds GSAP timelines
 * - scripts/gsap.ts manages ScrollTrigger cleanup/refresh
 *
 * To add a new transition type:
 * 1. Add the type name to TransitionType in scripts/transitions/index.ts
 * 2. Add exit and enter timeline factories in the same file
 * 3. Add route matching logic in getTransitionType() below
 * 4. Create a spec file in scripts/transitions/specs/types/
 * 5. Update the route matrix in scripts/transitions/specs/mappings/
 */
---

<script>
  import type { TransitionBeforePreparationEvent } from 'astro:transitions/client'

  import { cleanupScrollTriggers, refreshScrollTriggers } from '@/scripts/gsap'
  import type { TransitionRuntimeContext, TransitionType } from '@/scripts/transitions'
  import { playEnterTransition, playExitTransition } from '@/scripts/transitions'

  const MOBILE_BREAKPOINT_QUERY = '(max-width: 767px)'

  let activeTransitionType: TransitionType = 'fade'
  let activeTransitionContext: TransitionRuntimeContext = {
    fromPath: '/',
    toPath: '/',
    isMobile: false,
    prefersReducedMotion: false,
  }

  // ─── Path helpers ──────────────────────────────────────────

  const normalizePath = (path: string) => path.replace(/\/+$/, '') || '/'

  // TODO: Add project-specific route matchers here, e.g.:
  // const isProjectPath = (path: string) => path.startsWith('/projects/')

  // ─── Transition type resolution ────────────────────────────

  /**
   * Determine which transition to play based on navigation context.
   *
   * Priority:
   * 1. Explicit types passed via navigate(url, { info: 'skip' })
   * 2. Route-pattern matching (add project-specific rules here)
   * 3. Default fallback: 'fade'
   */
  function getTransitionType(event: TransitionBeforePreparationEvent): TransitionType {
    // Uncomment and use these when adding route-based transition logic:
    // const fromPath = normalizePath(event.from?.pathname ?? window.location.pathname)
    // const toPath = normalizePath(event.to?.pathname ?? '')

    // Explicit overrides via navigate(url, { info })
    if (event.info === 'skip') return 'none'

    // TODO: Add route-based type inference here, e.g.:
    // if (isProjectPath(fromPath) && isProjectPath(toPath)) return 'projectToProject'

    return 'fade'
  }

  // ─── Runtime context ───────────────────────────────────────

  function buildTransitionContext(fromPath: string, toPath: string): TransitionRuntimeContext {
    return {
      fromPath,
      toPath,
      isMobile: window.matchMedia(MOBILE_BREAKPOINT_QUERY).matches,
      prefersReducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
    }
  }

  function getTransitionContainer(): HTMLElement {
    return document.querySelector('main') || document.body
  }

  // ─── Lifecycle handlers ────────────────────────────────────

  /**
   * Before preparation: determine type, run exit animation, then load new page.
   * The exit animation runs in parallel with the page fetch for perceived speed.
   */
  function onBeforePrep(event: TransitionBeforePreparationEvent) {
    const fromPath = normalizePath(event.from?.pathname ?? window.location.pathname)
    const toPath = normalizePath(event.to?.pathname ?? '')
    activeTransitionType = getTransitionType(event)
    activeTransitionContext = buildTransitionContext(fromPath, toPath)

    if (activeTransitionType === 'none') return

    const originalLoader = event.loader

    event.loader = async () => {
      window.lenis?.stop()
      cleanupScrollTriggers()

      const container = getTransitionContainer()
      const loadPromise = originalLoader()
      await playExitTransition(activeTransitionType, container, activeTransitionContext)
      await loadPromise
    }
  }

  /**
   * After swap: scroll to top, play entrance animation, restart Lenis.
   */
  function onAfterSwap() {
    window.lenis?.scrollTo(0, { immediate: true })

    const container = getTransitionContainer()
    playEnterTransition(activeTransitionType, container, activeTransitionContext)
      .catch(console.error)
      .finally(() => {
        window.lenis?.start()
      })
  }

  /**
   * Page load: refresh ScrollTrigger positions after new content renders.
   */
  function onPageLoad() {
    requestAnimationFrame(() => {
      refreshScrollTriggers()
    })
  }

  document.addEventListener('astro:before-preparation', onBeforePrep)
  document.addEventListener('astro:after-swap', onAfterSwap)
  document.addEventListener('astro:page-load', onPageLoad)
</script>
