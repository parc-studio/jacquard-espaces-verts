---
/**
 * Home Section – single project (fullscreen or gallery mode).
 */
import type { HOME_PAGE_QUERY_RESULT } from '../../../sanity.types'
import HomeProjectGallery from '../media/HomeProjectGallery.svelte'
import Media from '../media/Media.svelte'
import { formatProjectSubtitle } from '../../utils'

type ProjectSection = Extract<
  NonNullable<NonNullable<HOME_PAGE_QUERY_RESULT>['sections']>[number],
  { _type: 'homeSectionProjectReference' }
>

interface Props {
  section: ProjectSection
  isLastSection: boolean
}

const { section, isLastSection } = Astro.props

const project = section.project
const displayMode = section.displayMode as string | undefined
const isGalleryMode = displayMode === 'galleryImage' || displayMode === 'carouselImage'
---

{
  !project ? (
    <section
      class:list={['section', 'section-project-fullscreen', { 'section-last': isLastSection }]}
    >
      <div class="project-block-link project-block-link-fallback">
        <div class="project-media-fallback">
          <div class="overlay-content overlay-content-static">
            <h2>Projet à renseigner</h2>
            <p>Sélectionnez un projet dans le builder</p>
          </div>
        </div>
      </div>
    </section>
  ) : isGalleryMode ? (
    <section class:list={['section', 'section-project-gallery', { 'section-last': isLastSection }]}>
      <HomeProjectGallery
        images={project.mediaGallery || []}
        href={project.slug?.current ? `/projects/${project.slug.current}` : '#'}
        title={project.titre || 'Projet sans titre'}
        location={project.localisation || 'Localisation à venir'}
        anneeDebut={project.anneeDebut}
        anneeFin={project.anneeFin}
        expertises={project.expertises}
        client:load
      />
    </section>
  ) : (
    <section
      class:list={['section', 'section-project-fullscreen', { 'section-last': isLastSection }]}
    >
      <a
        href={project.slug?.current ? `/projects/${project.slug.current}` : '#'}
        class="project-block-link"
      >
        {project.mediaGallery?.[0] ? (
          <>
            <Media media={{ image: project.mediaGallery[0] }} layout="cover" client:visible />
            <div class="overlay-content">
              <h2>{project.titre || 'Projet sans titre'}</h2>
              <p>
                {formatProjectSubtitle(
                  project.localisation || 'Localisation à venir',
                  project.anneeDebut,
                  project.anneeFin
                )}
              </p>
            </div>
          </>
        ) : (
          <div class="project-media-fallback">
            <div class="overlay-content overlay-content-static">
              <h2>{project.titre || 'Projet sans titre'}</h2>
              <p>
                {formatProjectSubtitle(
                  project.localisation || 'Localisation à venir',
                  project.anneeDebut,
                  project.anneeFin
                )}
              </p>
            </div>
          </div>
        )}
      </a>
    </section>
  )
}
