---
/**
 * Project Template
 *
 * Self-fetching template for project pages.
 * Displays project with cover image, gallery, and tags.
 *
 * SCAFFOLDING: Customize this template:
 * 1. Update the getProject query for your needs
 * 2. Add Svelte components for interactive galleries
 * 3. Connect Media components for images/video
 */
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getProject } from '../../data/sanity'
import { urlFor } from '../../utils/sanity/image'
import Media from '../media/Media.svelte'

interface Props {
  currentSlug: string
  isPreview?: boolean
}

const { currentSlug, isPreview = false } = Astro.props

// Fetch project data
const project = await getProject(currentSlug, { preview: isPreview })

// Extract data with defaults
const gallery = project?.gallery || []
const tags = project?.tags || []

// Extract SEO
const title = project?.seo?.title || project?.name
const description = project?.seo?.description || project?.description || ''
let image: string | undefined
const rawImage = project?.seo?.image || project?.coverImage
if (rawImage) {
  image = urlFor(rawImage).width(1200).height(630).url()
}
---

<BaseLayout
  title={title}
  description={description}
  image={image}
  isPreview={isPreview}
  pagePath={`/projects/${currentSlug}`}
>
  <main class="project-template main-grid">
    {
      project?.coverImage && (
        <div class="cover">
          <Media media={{ image: project.coverImage }} sizes="100vw" layout="contain" client:load />
        </div>
      )
    }

    <article class="project-content">
      <header class="header">
        <h1 class="name">{project?.name || 'Project Not Found'}</h1>
        {project?.description && <p class="description">{project.description}</p>}

        {
          tags.length > 0 && (
            <div class="tags">
              {tags.map((tag) => (
                <span class="tag">{tag.name}</span>
              ))}
            </div>
          )
        }
      </header>

      {
        gallery.length > 0 && (
          <section class="gallery">
            <h2 class="section-title">Gallery</h2>
            <div class="gallery-grid">
              {gallery.map((item) => (
                <figure class="gallery-item">
                  <Media
                    media={{ image: item }}
                    sizes="(max-width: 768px) 100vw, 50vw"
                    layout="contain"
                    client:load
                  />
                  {item.caption && <figcaption>{item.caption}</figcaption>}
                </figure>
              ))}
            </div>
          </section>
        )
      }
    </article>
  </main>

  <style>
    .project-template {
      min-height: 100vh;
    }

    .cover {
      grid-column: 1 / -1;
      aspect-ratio: 16 / 9;
      position: relative;
      overflow: hidden;
      max-height: 70vh;
      margin: auto;
      margin-top: 10vh;
    }

    .project-content {
      grid-column: 2 / -2;
    }

    .header {
      margin-bottom: var(--size-48);
    }

    .name {
      font-size: var(--text-48);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--size-16);
    }

    .description {
      font-size: var(--text-18);
      color: var(--color-text-light);
      line-height: var(--line-height-relaxed);
      max-width: 600px;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--size-8);
      margin-top: var(--size-24);
    }

    .tag {
      background: var(--color-surface);
      padding: var(--size-4) var(--size-12);
      border-radius: var(--radius-full);
      font-size: var(--text-12);
      color: var(--color-text-light);
    }

    .section-title {
      font-size: var(--text-24);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--size-24);
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--size-24);
    }

    .gallery-item {
      overflow: hidden;
      border-radius: var(--radius-md);
    }

    .gallery-item figcaption {
      padding: var(--size-12);
      font-size: var(--text-14);
      color: var(--color-text-light);
      text-align: center;
    }
  </style>
</BaseLayout>
