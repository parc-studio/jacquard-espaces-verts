---
/**
 * Project Template
 */
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getProject } from '../../data/sanity'
import { urlFor } from '../../utils/sanity/image'
import Media from '../media/Media.svelte'

interface Props {
  currentSlug: string
  isPreview?: boolean
}

const { currentSlug, isPreview = false } = Astro.props

const project = await getProject(currentSlug, { preview: isPreview })
const title = project?.seo?.title || project?.titre
const description = project?.seo?.description || project?.localisation || ''
let image: string | undefined
const rawImage = project?.seo?.image || project?.heroMedia?.image
if (rawImage) {
  image = urlFor(rawImage).width(1200).height(630).url()
}

const infoRows = [
  { label: 'Localisation', value: project?.localisation },
  {
    label: 'Année',
    value: project?.anneeFin
      ? `${project?.anneeDebut} – ${project?.anneeFin}`
      : project?.anneeDebut,
  },
  {
    label: 'Expertises',
    value: project?.expertises
      ?.map((item) => item?.title)
      .filter(Boolean)
      .join(', '),
  },
  { label: 'Techniques', value: project?.techniques?.join(', ') },
  {
    label: 'Budget',
    value: project?.budget ? `${project.budget.toLocaleString('fr-FR')} €` : undefined,
  },
  {
    label: 'Aire',
    value: project?.aireM2 ? `${project.aireM2.toLocaleString('fr-FR')} m²` : undefined,
  },
  { label: "Maître d'ouvrage", value: project?.maitreOuvrage },
  { label: "Maître d'œuvre", value: project?.maitreOeuvre },
  { label: 'Architecte', value: project?.architecte },
].filter((row) => !!row.value)
---

<BaseLayout
  title={title}
  description={description}
  image={image}
  isPreview={isPreview}
  pagePath={`/projects/${currentSlug}`}
>
  <main class="project-template main-grid">
    <section class="project-main">
      <aside class="project-sidebar">
        <a href="/projects" class="back-link">← Retour</a>
        <h1 class="project-title">{project?.titre || 'Projet'}</h1>
        {project?.localisation && <p class="project-location">{project.localisation}</p>}
        {
          project?.anneeDebut && (
            <p class="project-years">
              {project.anneeDebut}
              {project.anneeFin ? `–${project.anneeFin}` : ''}
            </p>
          )
        }
      </aside>

      <div class="project-hero">
        {
          project?.heroMedia && (
            <Media media={project.heroMedia} layout="cover" sizes="100vw" client:load />
          )
        }
      </div>
    </section>

    {
      infoRows.length > 0 && (
        <section class="project-info">
          <h2>Informations</h2>
          <dl>
            {infoRows.map((row) => (
              <>
                <dt>{row.label}</dt>
                <dd>{row.value}</dd>
              </>
            ))}
          </dl>
        </section>
      )
    }

    {
      project?.mediaCarousel && project.mediaCarousel.length > 0 && (
        <section class="project-carousel">
          <h2>Aire</h2>
          <div class="project-carousel-track">
            {project.mediaCarousel.map((item) => (
              <figure class="project-carousel-item">
                <Media
                  media={{ image: item }}
                  layout="cover"
                  sizes="(max-width: 767px) 60vw, 12vw"
                  client:load
                />
              </figure>
            ))}
          </div>
        </section>
      )
    }
  </main>

  <style>
    .project-template {
      padding-top: var(--size-24);
      padding-bottom: var(--size-64);
    }

    .project-main {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(8, minmax(0, 1fr));
      gap: var(--size-16);
    }

    .project-sidebar {
      grid-column: 1 / -1;
      display: grid;
      align-content: start;
      gap: var(--size-12);
    }

    .back-link {
      text-transform: uppercase;
      text-decoration: none;
      color: var(--color-primary);
      font-size: var(--text-12);
      width: fit-content;
    }

    .back-link:focus-visible,
    .back-link:hover {
      opacity: 0.7;
    }

    .project-title {
      font-size: var(--text-30);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
    }

    .project-location,
    .project-years {
      font-size: var(--text-16);
      text-transform: uppercase;
    }

    .project-hero {
      grid-column: 1 / -1;
      aspect-ratio: 16 / 10;
      overflow: hidden;
    }

    .project-info,
    .project-carousel {
      grid-column: 1 / -1;
      display: grid;
      gap: var(--size-16);
    }

    .project-info h2,
    .project-carousel h2 {
      font-size: var(--text-12);
      text-transform: uppercase;
      text-decoration: underline;
    }

    .project-info dl {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--size-8) var(--size-32);
    }

    .project-info dt {
      font-size: var(--text-14);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
    }

    .project-info dd {
      font-size: var(--text-16);
      margin: 0;
    }

    .project-carousel-track {
      display: flex;
      gap: var(--size-8);
      overflow-x: auto;
    }

    .project-carousel-item {
      flex: 0 0 120px;
      aspect-ratio: 5 / 4;
      overflow: hidden;
      margin: 0;
    }

    @media (min-width: 1024px) {
      .project-sidebar {
        grid-column: span 2;
      }

      .project-hero {
        grid-column: span 6;
      }

      .project-info dl {
        grid-template-columns: auto 1fr;
        align-items: start;
      }

      .project-carousel-item {
        flex-basis: 75px;
      }
    }
  </style>
</BaseLayout>
