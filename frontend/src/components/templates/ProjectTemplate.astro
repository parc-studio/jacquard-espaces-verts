---
/**
 * Project Template
 *
 * Two-section layout:
 * - Section 1: 100vh hero with click-left/right image carousel + project title
 * - Section 2: Info grid, thumbnails, and next project CTA
 */
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getProject, getAllProjects } from '../../data/sanity'
import { urlFor } from '../../utils/sanity/image'
import ProjectPage from './ProjectPage.svelte'
import type { Slug } from '../../../sanity.types'

interface NextProjectData {
  titre: string
  slug: Slug
  localisation: string
  anneeDebut: number
  anneeFin: number | null
}

interface Props {
  currentSlug: string
  isPreview?: boolean
  nextProject?: NextProjectData | null
}

const { currentSlug, isPreview = false, nextProject: nextProjectProp } = Astro.props

const project = await getProject(currentSlug, { preview: isPreview })
const title = project?.seo?.title || project?.titre
const description = project?.seo?.description || project?.localisation || ''
const mainImage = project?.mediaGallery?.[0]
let image: string | undefined
const rawImage = project?.seo?.image || mainImage
if (rawImage) {
  image = urlFor(rawImage).width(1200).height(630).url()
}

// In preview mode, compute next project since getStaticPaths doesn't run
let nextProject = nextProjectProp ?? null
if (!nextProject && isPreview && project) {
  try {
    const allProjects = await getAllProjects({ preview: true })
    if (allProjects && allProjects.length > 1) {
      const currentIndex = allProjects.findIndex((p) => p.slug?.current === currentSlug)
      if (currentIndex !== -1) {
        const nextIndex = (currentIndex + 1) % allProjects.length
        const next = allProjects[nextIndex]
        nextProject = {
          titre: next.titre,
          slug: next.slug,
          localisation: next.localisation,
          anneeDebut: next.anneeDebut,
          anneeFin: next.anneeFin,
        }
      }
    }
  } catch (error) {
    console.error('[ProjectTemplate] Unable to load next project:', error)
  }
}
---

<BaseLayout
  title={title}
  description={description}
  image={image}
  isPreview={isPreview}
  pagePath={`/projects/${currentSlug}`}
  hideHeader={true}
  contentBackground="var(--color-white)"
>
  {
    project && (
      <main class="project-template main-grid">
        <ProjectPage project={project} nextProject={nextProject} client:load />
      </main>
    )
  }

  <style>
    .project-template {
      background: var(--color-white);
    }
  </style>
</BaseLayout>
