---
/**
 * Home Template
 */
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getHomePage } from '../../data/sanity'
import HomeProjectGallery from '../media/HomeProjectGallery.svelte'
import Media from '../media/Media.svelte'
import { slugify } from '../../utils'

interface Props {
  isPreview?: boolean
}

const { isPreview = false } = Astro.props

const homePage = await getHomePage({ preview: isPreview })
const sections = homePage?.sections ?? []

const title = homePage?.seo?.title || homePage?.title || 'Accueil'
const description = homePage?.seo?.description || 'Jacquard Espaces Verts'

function formatSubtitle(location: string, anneeDebut?: number, anneeFin?: number | null): string {
  const parts: string[] = []
  if (location) parts.push(location)
  if (anneeDebut) {
    parts.push(anneeFin && anneeFin !== anneeDebut ? `${anneeDebut}–${anneeFin}` : `${anneeDebut}`)
  }
  return parts.join(', ')
}
---

<BaseLayout title={title} description={description} isPreview={isPreview} pagePath="/">
  <main class="home-page">
    {
      sections.length === 0 && (
        <section class="section section-empty-state main-grid">
          <div class="fallback-surface">
            <h2>Contenu à venir</h2>
            <p>Ajoutez des sections dans le constructeur de page d'accueil.</p>
          </div>
        </section>
      )
    }

    {
      sections.map((section, index) => {
        const isLastSection = index === sections.length - 1

        if (section._type === 'homeSectionProjectReference') {
          const project = section.project
          const displayMode = section.displayMode as string | undefined
          const isGalleryMode = displayMode === 'galleryImage' || displayMode === 'carouselImage'
          if (!project) {
            return (
              <section
                class:list={[
                  'section',
                  'section-project-fullscreen',
                  { 'section-last': isLastSection },
                ]}
              >
                <div class="project-block-link project-block-link-fallback">
                  <div class="project-media-fallback">
                    <div class="overlay-content overlay-content-static">
                      <h2>Projet à renseigner</h2>
                      <p>Sélectionnez un projet dans le builder</p>
                    </div>
                  </div>
                </div>
              </section>
            )
          }

          const mainImage = project.mediaGallery?.[0]
          const href = project.slug?.current ? `/projects/${project.slug.current}` : '#'
          const projectTitle = project.titre || 'Projet sans titre'
          const projectLocation = project.localisation || 'Localisation à venir'

          if (isGalleryMode) {
            return (
              <section
                class:list={[
                  'section',
                  'section-project-gallery',
                  { 'section-last': isLastSection },
                ]}
              >
                <HomeProjectGallery
                  images={project.mediaGallery || []}
                  href={href}
                  title={projectTitle}
                  location={projectLocation}
                  anneeDebut={project.anneeDebut}
                  anneeFin={project.anneeFin}
                  expertises={project.expertises}
                  client:load
                />
              </section>
            )
          }

          return (
            <section
              class:list={[
                'section',
                'section-project-fullscreen',
                { 'section-last': isLastSection },
              ]}
            >
              <a href={href} class="project-block-link">
                {mainImage ? (
                  <>
                    <Media media={{ image: mainImage }} layout="cover" client:visible />
                    <div class="overlay-content">
                      <h2>{projectTitle}</h2>
                      <p>{formatSubtitle(projectLocation, project.anneeDebut, project.anneeFin)}</p>
                    </div>
                  </>
                ) : (
                  <div class="project-media-fallback">
                    <div class="overlay-content overlay-content-static">
                      <h2>{projectTitle}</h2>
                      <p>{formatSubtitle(projectLocation, project.anneeDebut, project.anneeFin)}</p>
                    </div>
                  </div>
                )}
              </a>
            </section>
          )
        }

        if (section._type === 'homeSectionProjectPair') {
          const projects = section.projects?.filter((project) => !!project) || []
          const slots = [projects[0], projects[1]]

          return (
            <section
              class:list={[
                'section',
                'section-project-pair',
                'main-grid',
                { 'section-last': isLastSection },
              ]}
            >
              {slots.map((project, index) => {
                if (!project) {
                  return (
                    <div class="project-pair-item project-pair-item-fallback">
                      <div class="project-media-fallback">
                        <div class="overlay-content overlay-content-static">
                          <h2>Projet {index + 1} à renseigner</h2>
                          <p>Sélectionnez un projet</p>
                        </div>
                      </div>
                    </div>
                  )
                }

                const href = project.slug?.current ? `/projects/${project.slug.current}` : '#'
                const projectTitle = project.titre || 'Projet sans titre'
                const projectLocation = project.localisation || 'Localisation à venir'
                const pairSubtitle = formatSubtitle(
                  projectLocation,
                  project.anneeDebut,
                  project.anneeFin
                )
                const mainImage = project.mediaGallery?.[0]

                return (
                  <a href={href} class="project-pair-item">
                    {mainImage ? (
                      <>
                        <Media media={{ image: mainImage }} layout="cover" client:visible />
                        <div class="overlay-content">
                          <h2>{projectTitle}</h2>
                          <p>{pairSubtitle}</p>
                        </div>
                      </>
                    ) : (
                      <div class="project-media-fallback">
                        <div class="overlay-content overlay-content-static">
                          <h2>{projectTitle}</h2>
                          <p>{pairSubtitle}</p>
                        </div>
                      </div>
                    )}
                  </a>
                )
              })}
            </section>
          )
        }

        if (section._type === 'homeSectionExpertiseReference') {
          const expertiseTitle = section.expertise?.title || 'Expertise à renseigner'
          const expertiseDescription =
            section.expertise?.shortDescription ||
            section.expertise?.description ||
            "Ajoutez une expertise pour afficher son descriptif sur la page d'accueil."

          return (
            <section
              class:list={[
                'section',
                'section-expertise',
                'main-grid',
                { 'section-last': isLastSection },
              ]}
            >
              <div class="section-expertise-content">
                <h2>{expertiseTitle}</h2>
                <p>{expertiseDescription}</p>
                <a href={`/about#${slugify(expertiseTitle)}`} class="expertise-cta">
                  En Savoir plus
                </a>
              </div>
            </section>
          )
        }

        return (
          <section
            class:list={[
              'section',
              'section-empty-state',
              'main-grid',
              { 'section-last': isLastSection },
            ]}
          >
            <div class="fallback-surface">
              <h2>Bloc non pris en charge</h2>
              <p>Ce type de section n'est pas encore pris en charge sur la page d'accueil.</p>
            </div>
          </section>
        )
      })
    }

    <div class="home-footer-backdrop" aria-hidden="true"></div>
  </main>

  <style>
    .home-page {
      position: relative;
      display: flex;
      flex-direction: column;
      background-color: var(--color-white);
    }

    .home-footer-backdrop {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--size-20);
      background: var(--color-primary);
      pointer-events: none;
    }

    .section {
      position: relative;
      z-index: 1;
      background: var(--color-white);
    }

    .section-last {
      border-radius: 0 0 var(--size-20) var(--size-20);
      overflow: hidden;
    }

    .section-project-fullscreen.section-last,
    .section-project-pair.section-last {
      border-radius: 0;
      overflow: visible;
    }

    .section-project-fullscreen.section-last .project-block-link,
    .section-project-fullscreen.section-last .project-block-link-fallback,
    .section-project-pair.section-last .project-pair-item {
      border-radius: 0 0 var(--size-20) var(--size-20);
      overflow: hidden;
    }

    .section-project-fullscreen {
      aspect-ratio: 1440 / 766;
      min-height: 50vh;
    }

    .section-project-gallery {
      min-height: 50vh;
    }

    .project-block-link {
      display: block;
      position: relative;
      width: 100%;
      height: 100%;
      color: inherit;
      text-decoration: none;
    }

    .project-block-link-fallback {
      cursor: default;
    }

    .project-pair-item {
      grid-column: span 6;
      position: relative;
      aspect-ratio: 3 / 2;
      min-height: 40vh;
      color: inherit;
      text-decoration: none;
    }

    .project-pair-item-fallback {
      display: block;
    }

    .project-media-fallback {
      width: 100%;
      height: 100%;
      min-height: 40vh;
      background: var(--color-primary);
      display: grid;
      place-items: center;
    }

    .overlay-content {
      position: absolute;
      inset: 50% auto auto 50%;
      transform: translate(-50%, -50%);
      color: var(--color-white);
      text-align: center;
      z-index: var(--z-fixed);
      display: grid;
      row-gap: var(--size-10);
      width: min(90%, 560px);
      text-transform: uppercase;
      margin: 0;
    }

    .overlay-content h2,
    .overlay-content p {
      font-size: var(--text-20);
      font-weight: var(--font-weight-500);
    }

    .overlay-content.overlay-content-static {
      position: static;
      inset: auto;
      transform: none;
      width: min(90%, 640px);
    }

    .section-expertise-content {
      grid-column: 3 / 11;
      text-align: center;
      display: grid;
      gap: 40px;
      padding-block: 100px;
    }

    .section-expertise-content h2 {
      font-size: var(--text-16);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      margin: 0;
    }

    .section-expertise-content p {
      font-size: var(--size-42);
      line-height: var(--size-46);
      margin-inline: auto;
      margin-block: 0;
    }

    .expertise-cta {
      justify-self: center;
      color: var(--color-black);
      text-decoration: none;
      text-underline-offset: var(--size-2);
      border-bottom: 1px solid var(--color-black);
      padding-bottom: var(--size-2);
      text-transform: uppercase;
      font-size: var(--text-12);
    }

    .expertise-cta:focus-visible,
    .expertise-cta:hover {
      opacity: 0.7;
    }

    .section-empty-state {
      padding-block: var(--size-24);
    }

    .fallback-surface {
      grid-column: 1 / -1;
      background: var(--color-surface);
      text-align: center;
      display: grid;
      gap: var(--size-12);
      padding: var(--size-24);
    }

    .fallback-surface h2 {
      margin: 0;
      font-size: var(--text-20);
      text-transform: uppercase;
    }

    .fallback-surface p {
      margin: 0;
      font-size: var(--text-16);
      line-height: var(--line-height-125);
    }

    @media (max-width: 768px) {
      .section-project-fullscreen.section-last,
      .section-project-pair.section-last,
      .section-project-gallery.section-last {
        border-radius: 0 0 var(--size-20) var(--size-20);
        overflow: hidden;
      }

      .section-project-fullscreen.section-last .project-block-link,
      .section-project-fullscreen.section-last .project-block-link-fallback,
      .section-project-pair.section-last .project-pair-item {
        border-radius: 0;
        overflow: visible;
      }

      .project-pair-item {
        grid-column: 1 / -1;
      }

      .section-expertise-content {
        grid-column: 1 / -1;
      }
    }
  </style>
</BaseLayout>
