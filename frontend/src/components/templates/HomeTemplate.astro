---
/**
 * Home Template
 */
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getHomePage } from '../../data/sanity'
import Media from '../media/Media.svelte'

interface Props {
  isPreview?: boolean
}

const { isPreview = false } = Astro.props

const homePage = await getHomePage({ preview: isPreview })
const sections = homePage?.sections ?? []

const title = homePage?.seo?.title || homePage?.title || 'Accueil'
const description = homePage?.seo?.description || 'Jacquard Espaces Verts'
---

<BaseLayout title={title} description={description} isPreview={isPreview} pagePath="/">
  <main class="home-page">
    {
      sections.length === 0 && (
        <section class="section section-empty-state main-grid">
          <div class="fallback-surface">
            <h2>Contenu à venir</h2>
            <p>Ajoutez des sections dans le constructeur de page d'accueil.</p>
          </div>
        </section>
      )
    }

    {
      sections.map((section) => {
        if (section._type === 'homeSectionProjectReference') {
          const project = section.project
          if (!project) {
            return (
              <section class="section section-project-fullscreen">
                <div class="project-block-link project-block-link-fallback">
                  <div class="project-media-fallback">
                    <div class="overlay-content overlay-content-static">
                      <h2>Projet à renseigner</h2>
                      <p>Sélectionnez un projet dans le builder</p>
                    </div>
                  </div>
                </div>
              </section>
            )
          }

          const mainImage = project.mediaGallery?.[0]
          const href = project.slug?.current ? `/projects/${project.slug.current}` : '#'
          const projectTitle = project.titre || 'Projet sans titre'
          const projectLocation = project.localisation || 'Localisation à venir'

          return (
            <section class="section section-project-fullscreen">
              <a href={href} class="project-block-link">
                {mainImage ? (
                  <>
                    <Media media={{ image: mainImage }} layout="cover" client:visible />
                    <div class="overlay-content">
                      <h2>{projectTitle}</h2>
                      <p>{projectLocation}</p>
                    </div>
                  </>
                ) : (
                  <div class="project-media-fallback">
                    <div class="overlay-content overlay-content-static">
                      <h2>{projectTitle}</h2>
                      <p>{projectLocation}</p>
                    </div>
                  </div>
                )}
              </a>
            </section>
          )
        }

        if (section._type === 'homeSectionProjectPair') {
          const projects = section.projects?.filter((project) => !!project) || []
          const slots = [projects[0], projects[1]]

          return (
            <section class="section section-project-pair main-grid">
              {slots.map((project, index) => {
                if (!project) {
                  return (
                    <div class="project-pair-item project-pair-item-fallback">
                      <div class="project-media-fallback">
                        <div class="overlay-content overlay-content-static">
                          <h2>Projet {index + 1} à renseigner</h2>
                          <p>Sélectionnez un projet</p>
                        </div>
                      </div>
                    </div>
                  )
                }

                const href = project.slug?.current ? `/projects/${project.slug.current}` : '#'
                const projectTitle = project.titre || 'Projet sans titre'
                const projectLocation = project.localisation || 'Localisation à venir'
                const mainImage = project.mediaGallery?.[0]

                return (
                  <a href={href} class="project-pair-item">
                    {mainImage ? (
                      <>
                        <Media media={{ image: mainImage }} layout="cover" client:visible />
                        <div class="overlay-content">
                          <h2>{projectTitle}</h2>
                          <p>{projectLocation}</p>
                        </div>
                      </>
                    ) : (
                      <div class="project-media-fallback">
                        <div class="overlay-content overlay-content-static">
                          <h2>{projectTitle}</h2>
                          <p>{projectLocation}</p>
                        </div>
                      </div>
                    )}
                  </a>
                )
              })}
            </section>
          )
        }

        if (section._type === 'homeSectionExpertiseReference') {
          const expertiseTitle = section.expertise?.title || 'Expertise à renseigner'
          const expertiseDescription =
            section.expertise?.description ||
            "Ajoutez une expertise pour afficher son descriptif sur la page d'accueil."

          return (
            <section class="section section-expertise main-grid">
              <div class="section-expertise-content">
                <h2>{expertiseTitle}</h2>
                <p>{expertiseDescription}</p>
                <a href="/about" class="expertise-cta">
                  En Savoir plus
                </a>
              </div>
            </section>
          )
        }

        return (
          <section class="section section-empty-state main-grid">
            <div class="fallback-surface">
              <h2>Bloc non pris en charge</h2>
              <p>Ce type de section n'est pas encore pris en charge sur la page d'accueil.</p>
            </div>
          </section>
        )
      })
    }
  </main>

  <style>
    .home-page {
      display: flex;
      flex-direction: column;
      gap: var(--size-24);
      padding-bottom: var(--size-64);
    }

    .section {
      position: relative;
    }

    .section-project-fullscreen {
      aspect-ratio: 1440 / 766;
      min-height: 50vh;
    }

    .project-block-link {
      display: block;
      position: relative;
      width: 100%;
      height: 100%;
      color: inherit;
      text-decoration: none;
    }

    .project-block-link-fallback {
      cursor: default;
    }

    .section-project-pair {
      gap: var(--size-16);
    }

    .project-pair-item {
      grid-column: 1 / -1;
      position: relative;
      aspect-ratio: 3 / 2;
      min-height: 40vh;
      color: inherit;
      text-decoration: none;
    }

    .project-pair-item-fallback {
      display: block;
    }

    .project-media-fallback {
      width: 100%;
      height: 100%;
      min-height: 40vh;
      background: var(--color-primary);
      display: grid;
      place-items: center;
    }

    .overlay-content {
      position: absolute;
      inset: 50% auto auto 50%;
      transform: translate(-50%, -50%);
      color: var(--color-secondary);
      text-align: center;
      z-index: var(--z-base);
      display: grid;
      gap: var(--size-8);
      width: min(90%, 560px);
    }

    .overlay-content.overlay-content-static {
      position: static;
      inset: auto;
      transform: none;
      width: min(90%, 640px);
    }

    .overlay-content h2 {
      font-size: var(--text-24);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      margin: 0;
    }

    .overlay-content p {
      font-size: var(--text-16);
      text-transform: uppercase;
      margin: 0;
    }

    .section-expertise-content {
      grid-column: 1 / -1;
      text-align: center;
      display: grid;
      gap: var(--size-16);
      padding-block: var(--size-24);
    }

    .section-expertise-content h2 {
      font-size: var(--text-24);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      margin: 0;
    }

    .section-expertise-content p {
      font-size: var(--text-18);
      line-height: var(--line-height-normal);
      max-width: 56ch;
      margin-inline: auto;
      margin-block: 0;
    }

    .expertise-cta {
      justify-self: center;
      color: var(--color-primary);
      text-decoration: none;
      border-bottom: 1px solid var(--color-primary);
      text-transform: uppercase;
      font-size: var(--text-14);
    }

    .expertise-cta:focus-visible,
    .expertise-cta:hover {
      opacity: 0.7;
    }

    .section-empty-state {
      padding-block: var(--size-24);
    }

    .fallback-surface {
      grid-column: 1 / -1;
      background: var(--color-surface);
      text-align: center;
      display: grid;
      gap: var(--size-12);
      padding: var(--size-24);
    }

    .fallback-surface h2 {
      margin: 0;
      font-size: var(--text-20);
      text-transform: uppercase;
    }

    .fallback-surface p {
      margin: 0;
      font-size: var(--text-16);
      line-height: var(--line-height-normal);
    }

    @media (min-width: 768px) {
      .project-pair-item {
        grid-column: span 4;
      }
    }
  </style>
</BaseLayout>
