---
/**
 * Home Template – thin orchestrator that delegates each section
 * to a self-contained component.
 */
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getHomePage } from '../../data/sanity'
import HomeSectionExpertise from '../home/HomeSectionExpertise.astro'
import HomeSectionProject from '../home/HomeSectionProject.astro'
import HomeSectionProjectPair from '../home/HomeSectionProjectPair.astro'

interface Props {
  isPreview?: boolean
}

const { isPreview = false } = Astro.props

const homePage = await getHomePage({ preview: isPreview })
const sections = homePage?.sections ?? []

const title = homePage?.seo?.title || homePage?.title || 'Accueil'
const description = homePage?.seo?.description || 'Jacquard Espaces Verts'
---

<BaseLayout title={title} description={description} isPreview={isPreview} pagePath="/">
  <main class="home-page">
    {
      sections.length === 0 && (
        <section class="section section-empty-state main-grid">
          <div class="fallback-surface">
            <h2>Contenu à venir</h2>
            <p>Ajoutez des sections dans le constructeur de page d'accueil.</p>
          </div>
        </section>
      )
    }

    {
      sections.map((section, index) => {
        const isLastSection = index === sections.length - 1

        if (section._type === 'homeSectionProjectReference') {
          return <HomeSectionProject section={section} isLastSection={isLastSection} />
        }

        if (section._type === 'homeSectionProjectPair') {
          return <HomeSectionProjectPair section={section} isLastSection={isLastSection} />
        }

        if (section._type === 'homeSectionExpertiseReference') {
          return <HomeSectionExpertise section={section} isLastSection={isLastSection} />
        }

        return (
          <section
            class:list={[
              'section',
              'section-empty-state',
              'main-grid',
              { 'section-last': isLastSection },
            ]}
          >
            <div class="fallback-surface">
              <h2>Bloc non pris en charge</h2>
              <p>Ce type de section n'est pas encore pris en charge sur la page d'accueil.</p>
            </div>
          </section>
        )
      })
    }

    <div class="home-footer-backdrop" aria-hidden="true"></div>
  </main>

  <style is:global>
    .home-page {
      position: relative;
      display: flex;
      flex-direction: column;
      background-color: var(--color-white);
      padding-top: var(--size-50);
    }

    .home-footer-backdrop {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--size-20);
      background: var(--color-primary);
      pointer-events: none;
    }

    .section {
      position: relative;
      z-index: 1;
      background: var(--color-white);
    }

    .section-last {
      border-radius: 0 0 var(--size-20) var(--size-20);
      overflow: hidden;
    }

    .section-project-fullscreen.section-last,
    .section-project-pair.section-last {
      border-radius: 0;
      overflow: visible;
    }

    .section-project-fullscreen.section-last .project-block-link,
    .section-project-fullscreen.section-last .project-block-link-fallback,
    .section-project-pair.section-last .project-pair-item {
      border-radius: 0 0 var(--size-20) var(--size-20);
      overflow: hidden;
    }

    .section-project-fullscreen {
      aspect-ratio: 1440 / 766;
      min-height: 50vh;
    }

    .section-project-gallery {
      min-height: 50vh;
    }

    .project-block-link {
      display: block;
      position: relative;
      width: 100%;
      height: 100%;
      color: inherit;
      text-decoration: none;
    }

    .project-block-link-fallback {
      cursor: default;
    }

    .project-pair-item {
      grid-column: span 6;
      position: relative;
      aspect-ratio: 3 / 2;
      min-height: 40vh;
      color: inherit;
      text-decoration: none;
    }

    .project-pair-item-fallback {
      display: block;
    }

    .project-media-fallback {
      width: 100%;
      height: 100%;
      min-height: 40vh;
      background: var(--color-primary);
      display: grid;
      place-items: center;
    }

    .overlay-content {
      position: absolute;
      inset: 50% auto auto 50%;
      transform: translate(-50%, -50%);
      color: var(--color-white);
      text-align: center;
      z-index: var(--z-fixed);
      display: grid;
      row-gap: var(--size-10);
      width: min(90%, 560px);
      text-transform: uppercase;
      margin: 0;
    }

    .overlay-content h2,
    .overlay-content p {
      font-size: var(--text-20);
      font-weight: var(--font-weight-500);
    }

    .overlay-content.overlay-content-static {
      position: static;
      inset: auto;
      transform: none;
      width: min(90%, 640px);
    }

    .section-expertise-content {
      grid-column: 3 / 11;
      text-align: center;
      display: grid;
      gap: 40px;
      padding-block: 100px;
    }

    .section-expertise-content h2 {
      font-size: var(--text-16);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      margin: 0;
    }

    .section-expertise-content p {
      font-size: var(--size-42);
      line-height: var(--size-46);
      margin-inline: auto;
      margin-block: 0;
    }

    .expertise-cta {
      justify-self: center;
      color: var(--color-black);
      text-decoration: none;
      text-underline-offset: var(--size-2);
      border-bottom: 1px solid var(--color-black);
      padding-bottom: var(--size-2);
      text-transform: uppercase;
      font-size: var(--text-12);
    }

    .expertise-cta:focus-visible,
    .expertise-cta:hover {
      opacity: 0.7;
    }

    .section-empty-state {
      padding-block: var(--size-24);
    }

    .fallback-surface {
      grid-column: 1 / -1;
      background: var(--color-surface);
      text-align: center;
      display: grid;
      gap: var(--size-12);
      padding: var(--size-24);
    }

    .fallback-surface h2 {
      margin: 0;
      font-size: var(--text-20);
      text-transform: uppercase;
    }

    .fallback-surface p {
      margin: 0;
      font-size: var(--text-16);
      line-height: var(--line-height-125);
    }

    @media (max-width: 768px) {
      .section-project-fullscreen.section-last,
      .section-project-pair.section-last,
      .section-project-gallery.section-last {
        border-radius: 0 0 var(--size-20) var(--size-20);
        overflow: hidden;
      }

      .section-project-fullscreen.section-last .project-block-link,
      .section-project-fullscreen.section-last .project-block-link-fallback,
      .section-project-pair.section-last .project-pair-item {
        border-radius: 0;
        overflow: visible;
      }

      .project-pair-item {
        grid-column: 1 / -1;
      }

      .section-expertise-content {
        grid-column: 1 / -1;
      }
    }
  </style>
</BaseLayout>
